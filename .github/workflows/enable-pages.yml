name: Enable GitHub Pages
on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  enable-pages:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Configure Pages via API
        run: |
          set -e
          if [ -n "${{ secrets.PAGES_TOKEN }}" ]; then
            TOKEN="${{ secrets.PAGES_TOKEN }}"
            echo "Using PAGES_TOKEN secret"
          else
            TOKEN="${{ secrets.GITHUB_TOKEN }}"
            echo "PAGES_TOKEN not found, falling back to GITHUB_TOKEN (may fail if insufficient permissions)"
          fi

          echo "Setting Pages source to main / (root)..."
          http_code=$(curl -s -o /tmp/response -w "%{http_code}" -X PUT \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$GITHUB_REPOSITORY/pages \
            -d '{"source":{"branch":"main","path":"/"}}')

          echo "HTTP status: $http_code"
          cat /tmp/response || true

          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "Pages source successfully configured."
          else
            echo "Failed to configure Pages via API."
            echo "If you used GITHUB_TOKEN and it failed, add a repo-scoped PAT as secret PAGES_TOKEN and re-run the workflow."
            exit 1
          fi
